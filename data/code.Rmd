## Đọc dữ liệu
```{r}
library(dplyr)
library(tidyr)
library(rmarkdown)
library(ggplot2)

old_data <- read.csv("usa.csv")
paged_table(old_data) # thay thế cho print, in ra bảng đẹp hơn
```
## Làm sạch dữ liệu (Data cleaning)
Ta bỏ cột index và cột location vì location luôn cố định (USA).
```{r}
new_data <- old_data %>% select(3:14)
paged_table(new_data)
```
### Trích xuất các dữ liệu chính

Trong hoạt động này, ta sẽ xây dựng mô hình hồi quy bội dự đoán số ca tử vong mới (new_deaths) dựa trên 4 biến giải thích, bao gồm: new_cases (số ca mắc mới), new_tests (số ca xét nghiệm mới), hosp_patients (số ca nhập viện mới), positive_rate (tỉ lệ dương tính).

```{r}
main_data <- subset(new_data , select = c(new_deaths , new_cases , new_tests, hosp_patients , positive_rate))
# paged_table(main_data)
```
### Xử lý dữ liệu khuyết (NA)

Ta tiến hành kiểm tra xem số lượng/tỉ lệ dữ liệu khuyết của mỗi thuộc tính là bao nhiêu. Nguyên nhân xuất hiện dữ liệu khuyết có thể xuất phát từ nhiều yếu tố, điển hình nhất là thiếu sót trong việc thu thập dữ liệu ngoài thực tế và nguồn tiếp cận dữ liệu bị hạn chế.

```{r}
main_data %>% sapply(function(col) sum(is.na(col)))    #Số dữ liệu bị khuyết theo cột
apply(main_data, 2, function(x)sum(is.na(x))/length(x))    #Tỉ lệ dữ liệu bị khuyết
```
Tỉ lệ dữ liệu khuyết tương đối cao, nếu chỉ đơn giản thay các giá trị NA bằng 0 thì kết quả thống kê sẽ bị ảnh hưởng rất nhiều. Để an toàn, ta sẽ loại bỏ hẳn các hàng có chứa ít nhất một dữ liệu khuyết.

```{r}
main_data <- na.omit(main_data)
# main_data[is.na(main_data)] <- 0    #NA <- 0
paged_table(main_data)
```

## Làm rõ dữ liệu

### Thống kê đơn biến
Thực hiện các phương pháp thống kê đơn biến lên từng biến dự đoán, 1 vài phương pháp: Summary Statistics, Frequency Distribution Table, Bar chart, Histogram... 

#### Summary Statistics
Ta tính các gía trị thống kê mô tả cho mỗi biến, bao gồm: trung bình (mean), trung vị (median), độ lệch chuẩn (sd), min, max

```{r}
stat_table<-apply(main_data[,c("new_deaths", "new_cases", "new_tests", "hosp_patients", "positive_rate")], 2,
function(x){c(mean(x), median(x), sd(x), min(x), max(x))})
rownames(stat_table)<-c("mean", "median", "sd", "min", "max")
paged_table(as.data.frame(stat_table))
```

Dựa vào biểu đồ, ta nhận thấy giá trị của chúng bị lệch khá nhiều và không tuân theo phân phối chuẩn. Vì thế, ta thực hiện transform dữ liệu bằng hàm logarithm, với hi vọng là dữ liệu sau khi transform sẽ tuân theo phân phối chuẩn:

```{r}
plot_hist_norm <- function(data, var) {
  # Calculate the variable to plot
  plot_var <- data[[var]]
  par(mfrow = c(1, 2))
  # Histogram of the variable
  # Normal curve overlay
  hist(plot_var, main = paste0(var), xlab = "x",
     col = "blue", border = "white", breaks = 20, freq = FALSE)
  hist(log(plot_var), main = paste0("Log(", var, ")"), xlab = "ln(x)",
     col = "blue", border = "white", breaks = 20, freq = FALSE)
  curve(dnorm(x, mean = mean(log(plot_var)), sd = sd(log(plot_var))), 
        col = "red", lwd = 2, add = TRUE) 
}
for (col_name in colnames(main_data)) {
  # Call plot_hist_norm on each column
  plot_hist_norm(main_data, col_name)
}
```

Rõ ràng biểu đồ sau khi chuyển đổi dữ liệu có hình dạng giống phân phối chuẩn hơn. Vì thế, ta sẽ sử dụng bộ dữ liệu sau khi chuyển đổi:

```{r}
# Apply log data transformation to all variables
for (col_name in colnames(main_data)) {
  main_data[[col_name]] <- log(main_data[[col_name]])
}

stat_table<-apply(main_data[,c("new_deaths", "new_cases", "new_tests", "hosp_patients", "positive_rate")], 2,
function(x){c(mean(x), median(x), sd(x), min(x), max(x))})
rownames(stat_table)<-c("mean", "median", "sd", "min", "max")
paged_table(as.data.frame(stat_table))
```

### Thống kê đa biến

Ta tính ma trận hiệp phương sai của cả 5 biến này để kiểm tra sự phụ thuộc tuyến tính của từng cặp biến với nhau.

```{r}
paged_table(as.data.frame(cor(main_data)))
```

Dựng đồ thị mô tả sự tương quan giữa các cặp biến:

```{r}
contTab = subset(main_data, select = colnames(main_data))
pairs(contTab)
```

# Xây dựng mô hình hồi quy bội

## Ký hiệu
Một mô hình hồi quy tuyến tính bội (gọi tắt là hồi quy bội (HQB)) liên quan đến một biến ngẫu nhiên $Y$ và $k$ biến giải thích $x$ là phương trình:

$$Y = \beta_0 + \beta_1x_1 + \beta_2x_2 + ... + \beta_kx_k + \varepsilon$$

Trong đó:

- $\beta_0, \beta_1, \beta_2, ..., \beta_k$ là các tham số chưa biết ($\beta_0$ được gọi là hệ số chặn (intercept), $\beta_1, \beta_2, ..., \beta_k$ là hệ số góc (slope)).

- $Y$ là biến phụ thuộc, $x_i$ là biến độc lập ($i = 1..k$)

- $\varepsilon$ là thành phần sai số, được giả sử có phân phối chuẩn $\mathcal{N}(0, \sigma^2)$

Cụ thể trong hoạt động này, ta sẽ sử dụng $k=4$ biến giải thích:

$$Y = \beta_0 + \beta_1x_1 + \beta_2x_2 + \beta_3x_3 + \beta_4x_4 + \varepsilon$$

Từ $n$ mẫu ngẫu nhiên $(X_{1,1}, X_{2,1},...,X_{k,1}, Y_{1}), (X_{1,2}, X_{2,2},...,X_{k,2}, Y_{2}),...,(X_{1,n}, X_{2,n},...,X_{k,n}, Y_{n})$ ta có $n$ bộ giá trị quan trắc $(x_{1,1}, x_{2,1},...,x_{k,1}, y_{1}), (x_{1,2}, x_{2,2},...,x_{k,2}, y_{2}),...,(x_{1,n}, x_{2,n},...,x_{k,n}, y_{n})$. Mô hình hồi quy bội của mẫu là:

$$Y_i = \beta_0 + \beta_1x_{1,i} + \beta_2x_{2,i} + ... + \beta_kx_{k,i} + \varepsilon_i$$

Với $i = 1..n$. 

Mô hình cụ thể trong hoạt động này là:

$$Y_i = \beta_0 + \beta_1x_{1,i} + \beta_2x_{2,i} + \beta_3x_{3,i} + \beta_4x_{4,i} + \varepsilon_i$$

Vớii $i= 1..703$.

## Ước lượng tham số

Hàm hồi quy mẫu được xây dựng từ $n$ quan sát có dạng:

$$\hat{y}_i = \hat{\beta}_0 + \hat{\beta}_1x_{1,i} + \hat{\beta}_2x_{2,i} + ... + \hat{\beta}_kx_{k,i}$$

$$y_i = \hat{\beta}_0 + \hat{\beta}_1x_{1,i} + \hat{\beta}_2x_{2,i} + ... + \hat{\beta}_kx_{k,i} + \hat{\varepsilon}_i = \hat{y}_i + \hat{\varepsilon}_i$$

Với $i = 1..n$. Trong đó $\hat{\beta}_i$ là ước lượng của $\beta_i$, $\hat{\varepsilon}_i$ là ước lượng của $\varepsilon_i$ (phần dư của quan sát thứ $i$).

Ta có:

$$SSE = \sum_{i=1}^n \hat{\varepsilon}_i^2 = \sum_{i=1}^n (y_i - \hat{y}_i)^2$$

Ta sẽ tính các hệ số của mô hình sao cho $SSE$ đạt giá trị nhỏ nhất (Phương pháp bình phương cực tiểu).

Đối với mô hình cụ thể trong hoạt động 2, ta sẽ tính 5 hệ số $\hat{\beta}_0, \hat{\beta}_1, \hat{\beta}_2, \hat{\beta}_3, \hat{\beta}_4$ bằng cách minimize $SSE$:

```{r}
model <- lm(new_deaths ~ new_cases + new_tests + hosp_patients + positive_rate, 
            data = main_data)
summary(model)
# In ra cac he so cua mo hinh
paged_table(as.data.frame(t(model$coefficients)))
```

Vậy $(\hat{\beta}_0, \hat{\beta}_1, \hat{\beta}_2, \hat{\beta}_3, \hat{\beta}_4) = (-14.7827,	1.040907,	-0.2615094,	0.8891441,	-1.494801)$

```{r}
SSE <- (model$residuals ^ 2) %>% sum()
SSR <- ((model$fitted.values - mean(main_data$new_deaths)) ^ 2) %>% sum()
SST <- ((main_data$new_deaths - mean(main_data$new_deaths)) ^ 2) %>% sum()
table <- data.frame(SSE, SSR, SST)
# Print the table
paged_table(table)
```



## Ước lượng độ lệch chuẩn của sai số

Công thức tính phương sai của sai số:

$${\hat{\sigma}}^2 = \dfrac{SSE}{n-(k+1)}$$

Với $n$ là số lượng quan sát và $k$ là số lượng tham số hồi quy.

Tính độ lệch chuẩn của sai số:
```{r}
error_sd <- sqrt(SSE / (nrow(main_data) - 5))
print(error_sd)
```
## Xác định hệ số $R^2$ (Hệ số xác định)

Hệ số xác định (Coefficient of Determination) là tỷ lệ của tổng sự
biến thiên trong biến phụ thuộc gây ra bởi sự biến thiên của các biến
độc lập (biến giải thích) so với tổng sự biến thiên toàn phần. Hệ số
xác định thường được gọi là $R$. Công thức tính:

$$R^2 = \dfrac{SSR}{SST}$$

```{r}
R2 <- SSR / SST
print(paste0("R^2 = ", R2))
```

Hệ số $R^2$ hiệu chỉnh được tính bằng công thức sau:

$$R^2_{adjusted} = 1 - \dfrac{n-1}{n-(k+1)}(1-R^2)$$

```{r}
R2_adjusted <- 1 - (nrow(main_data) - 1)/(nrow(main_data) - 5)*(1-R2) 
print(paste0("Adjusted R^2 = ", R2_adjusted))
```

## Xác định khoảng tin cậy của các hệ số hồi quy
Khoảng tin cậy 95% các hệ số hồi qui:
```{r}
confint(model , level = 0.95)
```
## Kiểm định giả thuyết cho các hệ số hồi quy
$$F =\dfrac{n-k-1}{k}\dfrac{R^2}{1-R^2}$$
```{r}
f <-((nrow(main_data) - 5)/4)*(R2 / (1 - R2)) 
print(paste0("F = ", f))
```

### Kiểm định giả thuyết cho $\beta_0$

### Kiểm định giả thuyết cho $\beta_1$

### Kiểm định giả thuyết cho $\beta_2$

### Kiểm định giả thuyết cho $\beta_3$

### Kiểm định giả thuyết cho $\beta_4$

## Kiểm định sự phù hợp của mô hình hồi quy tuyến tính

Sai số chuẩn của mô hình (standard error of the fit) theo từng hệ số:

```{r}
se <- sqrt(diag(vcov(model)))
print(se)
```

## Dự đoán

Dự đoán giá trị:
```{r}
prediction <- data.frame(new_cases=c(log(500000)), new_tests=c(log(2000000)), hosp_patients=c(log(100000)), positive_rate = c(log(0.2)))
predict(model, prediction , interval = 'confidence')
```

Lưu ý, vì ở bước xử lý dữ liệu, ta đã thực hiện lấy logarithm tất cả dữ liệu, cho nên kết quả dự đoán chính là log(new_deaths). Để xác định giá trị new_deaths, ta làm thêm bước exponentiate: 

```{r}
prediction_result <- predict(model, prediction, interval = 'confidence')
prediction_result[, 1:3] <- exp(prediction_result[, 1:3])
print(prediction_result)
```

Trong ví dụ trên, với new_cases = 500000, new_tests = 2000000, hosp_patients = 100000 và positive_rate = 0.2, giá trị dự đoán của new_deaths sẽ là 2264, với 2100 và 2441 lần lượt là giới hạn tin cậy dưới và trên, mức tin cậy mặc định 95%.

